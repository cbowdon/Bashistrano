#!/usr/bin/env bash

config=bashistrano_conf.sh

source "$config"

command=${1:-main} # Default to a command called "main"

# TODO Could reduce data transfer by filtering for command (and sourced files)
user_commands=$(find . -name "*.sh" | grep -v "$config" | xargs cat)

for server in $servers
do
    read -r -d '' script <<-EOF
    set -u

    PATH=/usr/bin:/usr/local/bin:/bin
    # Make some vars available to user commands
    cmd_host=${HOSTNAME}
    cmd_user=${USER}

    # Make user's own config available to user commands
    $(cat $config)

    # Make some helper functions available to user commands
    message () {
        local fg_cyan="\$(tput setaf 6)"
        local reset="\$(tput sgr0)"
        echo "\${fg_cyan}[${user}@${server}]\${reset} \$1"
    }

    # Default command, can be redefined by user
    main () {
        message "Hello, world"
    }

    message "Connected"

    # Define all user commands
    $user_commands

    message "Running '$command' on $server"
    $command
EOF

    ssh -ttq ${user}@${server} "$script"
done
